<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/jquery-2.1.0.min.js" type="text/javascript"></script>
    <script src="js/underscore-min.js" type="text/javascript"></script>
    <script src="js/backbone-min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1 style="text-align:center"> Let's Chat Now!</h1>
      <div class="main container">
        <ul class="list-unstyled message-box">
        </ul>
        <div class="row">
          <div class="input-line col-lg-9">
            <div class="input-group">
              <input type="text" class="form-control" id="message">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" id="send">Send</button>
              </span>
            </div>
          </div>
            <div class="input-group col-lg-3" style="top:5px">
              <label id="name-label"> Joey </label>
              <input type="text" class="edit-input" id="edit-input" placeholder="Type in your name">
              <a src="#" id="edit" class="edit-label"> Edit </a>
              <a src="#" id="confirm" class="edit-label" style="display:none"> Confirm </a>
            </div><!-- /input-group -->
        </div>
      </div>
    </div>
  </body>
  <script type="text/template" id="message-list-template">
    <% _.each(messages,function(m){ %>
      <li><b><%= m.get("name") %></b> : <%=m.get("content")%></li>
    <% }); %>
  </script>
  <script>
    var Message = Backbone.Model.extend({
      defaults: {
        "name": "anonymous user"
      },
    });
    var MessageList = Backbone.Collection.extend({
      model :Message,
    });
    var MessageListView = Backbone.View.extend({
      el: ".main",
      events: {
        "click #send": "sendMessage",
        "click #edit": "editName",
        "click #confirm": "confirmName",
        "keypress": "enter"

      },
      initialize: function(options){
        _.bindAll(this,'render','updateList');
        this.messageList = options.messageList;
        this.name = "Joey";
        this.render();
      },
      render: function(){
        this.messageList.bind("reset",this.updateList);
        this.messageList.bind("add",this.updateList);
        this.updateList();
      },
      updateList: function(){
        var template = _.template($("#message-list-template").html(),{messages:this.messageList.models});
        this.$(".list-unstyled").html(template);
      },
      sendMessage: function(){
        var content = this.$("#message").val();
        if(content!==""){
          var message = new Message({name:this.name,content:content});
          this.messageList.add(message);
        }
      },
      enter :function(e){
        if(e.which == 13){
          if($("#message").is(":focus")){
            this.sendMessage();
          }
          if($("#edit-input").is(":focus")){
            this.confirmName();
          }
        }
      },
      editName: function(){
        this.$("#edit-input").show();
        this.$("#edit").hide();
        this.$("#confirm").show();
        this.$("#name-label").hide();
      },
      confirmName: function(){
        this.name = this.$("#edit-input").val();
        this.$("#edit-input").hide();
        this.$("#edit").show();
        this.$("#confirm").hide();
        this.$("#name-label").html(this.name);
        this.$("#name-label").show();
      },
    });

    var Router = Backbone.Router.extend({
      routes:{
        '':'home'
      }
    });
    var router = new Router();
    var message1 = new Message({name:"HR",content:"Hey,Joey. You did a good job! I am gonna give you an offer!"});
    var message2 = new Message({name:"Joey",content:"Thank you!"});
    var messageList = new MessageList();
    messageList.add(message1);
    messageList.add(message2);
    router.on('route:home',function(){
      var messageListView = new MessageListView({messageList: messageList});
    });
    Backbone.history.start();
  </script>
</html>

